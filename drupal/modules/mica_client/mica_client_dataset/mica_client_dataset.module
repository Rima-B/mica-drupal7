<?php

function mica_client_dataset_menu() {
  $items = array();

  $items['mica/datasets'] = array(
    'title' => 'Datasets',
    'description' => t('Published datasets'),
    'page callback' => 'mica_client_dataset_get_datastes',
    'file' => 'mica_client_datasets-page-list.inc',
    'access callback' => TRUE,
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 3
  );

  $items['mica/datasets/harmonization-datasets'] = array(
    'title' => 'Harmonization Datasets',
    'description' => t('Published harmonization datasets'),
    'page callback' => 'mica_client_dataset_get_harmonization_datasets',
    'file' => 'mica_client_datasets-page-list.inc',
    'access callback' => TRUE,
//   'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 2
  );

  $items['variable-detail-statistics/%'] = array(
    // 'title' => t('Datasets Opal variables'),
    'access callback' => TRUE,
    'page callback' => 'mica_client_dataset_variable_get_ajax_statistics',
    'page arguments' => array(1),
    'weight' => 5,
    'file' => 'mica_client_variable-page-detail.inc',
  );


  $items['mica/datasets/study-datasets'] = array(
    'title' => 'Study Datasets',
    'page callback' => 'mica_client_dataset_get_study_datasets',
    'file' => 'mica_client_datasets-page-list.inc',
    'access callback' => TRUE,
    //  'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
    'weight' => 3
  );

  $items['mica/study-dataset/%'] = array(
    'title' => 'Dataset',
    'page callback' => 'mica_client_dataset_page_detail',
    'file' => 'mica_client_dataset-page-detail.inc',
    'access callback' => TRUE,
    'page arguments' => array(1, 2),
  );

  $items['mica/harmonization-dataset/%'] = array(
    'title' => 'Dataset',
    'page callback' => 'mica_client_dataset_page_detail',
    'file' => 'mica_client_dataset-page-detail.inc',
    'access callback' => TRUE,
    'page arguments' => array(1, 2),
  );

  $items['mica/variable/%'] = array(
    'title' => 'Variable',
    'page callback' => 'mica_client_variable_page_detail',
    'file' => 'mica_client_variable-page-detail.inc',
    'access callback' => TRUE,
    'page arguments' => array(2),
  );
  return $items;
}

function mica_client_dataset_menu_link_alter(&$items) {
  if ($items['menu_name'] == 'main-menu') {
//    dpm($items);
  }
}

///**
// * Restrict access to /node
// */
//function mica_client_dataset_menu_alter(&$items) {
//  dpm($items);
//  $items['node']['access callback'] = FALSE;
//}


//function mica_client_dataset_menu_local_tasks_alter(&$data, $router_item, $root_path) {
//  $links = array();
//  //dpm($root_path);
//  switch ($root_path) {
//
//  }
//
//  $data['actions']['output'] = array_merge($data['actions']['output'], $links);
//}

/**
 * Implements hook_theme().
 *
 * copy '<modules>/mica_client_dataset/templates/'   files in  your customized theme  '<YOUR_THEME>/templates/' path
 * you can modify default display of listed page templates by rearrange block field for example
 * don't forget to clear the theme registry.
 *
 */

function mica_client_dataset_theme($existing, $type, $theme, $path) {
  $path_theme = $path . '/templates';
  return array(
    'mica_client_datasets-list' => array('template' => 'mica_client_datasets-list', 'path' => $path_theme),
    'mica_client_datasets-detail' => array('template' => 'mica_client_datasets-detail', 'path' => $path_theme),
    'mica_client_datasets-tables' => array('template' => 'mica_client_datasets-tables', 'path' => $path_theme),
    'mica_client_variable-detail' => array('template' => 'mica_client_variable-detail', 'path' => $path_theme),
    'mica_client_datasets-list-page' => array('template' => 'mica_client_datasets-list-page', 'path' => $path_theme),
  );
}

function mica_client_dataset_get_all_datasets_studies($study_id) {
  $output = NULL;
  $dataset_resource = new MicaDatasetResource();

  $datasets = array_merge($dataset_resource->get_datasetes('study-datasets', $study_id), $dataset_resource->get_datasetes('harmonization-datasets', $study_id));

  if (!empty($datasets)) {
    $output = mica_client_dataset_get_datasets_list($datasets);
  }

  return $output;
}

function mica_client_dataset_get_datasets_list($datasets) {
  $dataset_rows = array();
  foreach ($datasets as $key_dataset => $dataset_dto) {
    $dataset_description = NULL;
    if (!empty($dataset_dto->description)) {
      $dataset_description = theme('box', truncate_utf8(mica_client_commons_get_localized_field($dataset_dto, 'description'), 50, TRUE, TRUE));
    }
    $dataset_name = mica_client_commons_get_localized_field($dataset_dto, 'name');
    $dataset_type = $dataset_dto->hasExtension('obiba.mica.StudyDatasetDto.type') ? 'study-dataset' : 'harmonization-dataset';
    $dataset_type_name = $dataset_dto->hasExtension('obiba.mica.StudyDatasetDto.type') ? 'Study dataset' : 'Harmonization dataset';
    $dataset_rows[$key_dataset] = array(
      'data' => array(
        'label' => l($dataset_name, 'mica/' . $dataset_type . '/' . $dataset_dto->id . '/' . mica_client_commons_to_slug($dataset_name)),
        'type' => t($dataset_type_name),
        'desc' => !empty($dataset_description) ? $dataset_description : '-'
      )
    );
  }

  $dataset['dataset-tab'] = theme(
    'table',
    array(
      'header' => array(t('Name'), t('Type'), t('Description')),
      'rows' => $dataset_rows,
      'empty' => t('No dataset found'),
      'sticky' => FALSE
    )
  );
  return $dataset;
}

/**
 * @param null $attributes
 * @param null $namespace
 * @param array $excluded_names
 * @return bool|string
 */
function mica_client_dataset_attributes_tab($attributes = NULL, $namespace = NULL, $excluded_names = array()) {
  $rows = array();
  if (!empty($attributes)) {
    foreach ($attributes as $attribute) {
      if (empty($namespace) || !empty($attribute->namespace) && $namespace == $attribute->namespace) {
        if (empty($excluded_names) || !in_array($attribute->name, $excluded_names)) {
          $rows[] = array(
            t($attribute->name),
            mica_client_commons_get_localized_field($attribute, 'values'),
          );
        }
      }
    }
    return theme(
      'table',
      array(
        'header' => array(t('Name'), t('Value')),
        'rows' => $rows,
        'empty' => t('No attribute found'),
        'sticky' => FALSE,
        'attributes' => array('id' => 'variable_attributes')
      )
    );
  }

  return FALSE;
}
